name: å®Œæ•´æµ‹è¯•å¥—ä»¶

# å®Œæ•´æµ‹è¯•åœ¨ä»¥ä¸‹æƒ…å†µè¿è¡Œï¼š
# 1. Pushåˆ°main/developåˆ†æ”¯
# 2. PRåˆå¹¶å
# 3. PRæ·»åŠ ready-for-testæ ‡ç­¾
on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [closed, labeled]
    branches: [ main, develop ]

# å–æ¶ˆåŒä¸€åˆ†æ”¯çš„æ—§æ„å»º
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ================================
  # åç«¯æµ‹è¯•
  # ================================
  backend-unit-test:
    name: åç«¯å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    # åªåœ¨ä»¥ä¸‹æƒ…å†µè¿è¡Œï¼špushã€PRåˆå¹¶åã€æˆ–æ·»åŠ ready-for-testæ ‡ç­¾
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true) ||
      (github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == 'ready-for-test')
    
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£…uvåŒ…ç®¡ç†å™¨
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–ï¼ˆå«æµ‹è¯•ä¾èµ–ï¼‰
        run: |
          uv sync --extra test
      
      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          cd backend
          uv run pytest tests/unit -v --cov=. --cov-report=xml --cov-report=term
        continue-on-error: false
      
      - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage

  backend-integration-test:
    name: åç«¯é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: backend-unit-test
    
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ğŸ“¦ å®‰è£…uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–ï¼ˆå«æµ‹è¯•ä¾èµ–ï¼‰
        run: uv sync --extra test
      
      - name: ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•
        run: |
          cd backend
          uv run pytest tests/integration -v
        env:
          # ä½¿ç”¨mockæ¨¡å¼ï¼Œä¸ä¾èµ–çœŸå®API
          TESTING: true
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY || 'mock-api-key-for-testing' }}

  # ================================
  # å‰ç«¯æµ‹è¯•
  # ================================
  frontend-test:
    name: å‰ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          cd frontend
          npm ci
      
      - name: ğŸ” Lintæ£€æŸ¥
        run: |
          cd frontend
          npm run lint
      
      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          cd frontend
          npm test -- --run --coverage
        continue-on-error: false
      
      - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v4
        with:
          file: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
      
      - name: ğŸ—ï¸ æ„å»ºæ£€æŸ¥
        run: |
          cd frontend
          npm run build

  # ================================
  # Dockerç¯å¢ƒæµ‹è¯•
  # ================================
  docker-test:
    name: Dockerç¯å¢ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [backend-integration-test, frontend-test]
    
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          cp .env.example .env
          # æ³¨å…¥æµ‹è¯•ç”¨çš„APIå¯†é’¥
          echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY || 'mock-api-key' }}" >> .env
      
      - name: ğŸ³ æ„å»ºDockeré•œåƒ
        run: |
          docker-compose build --no-cache
      
      - name: ğŸš€ å¯åŠ¨æœåŠ¡
        run: |
          docker-compose up -d
          echo "ç­‰å¾…æœåŠ¡å°±ç»ª..."
          sleep 20
      
      - name: ğŸ¥ å¥åº·æ£€æŸ¥
        run: |
          # åç«¯å¥åº·æ£€æŸ¥
          echo "æ£€æŸ¥åç«¯..."
          for i in {1..30}; do
            if curl -f http://localhost:5000/health; then
              echo "âœ“ åç«¯å¯åŠ¨æˆåŠŸ"
              break
            fi
            echo "ç­‰å¾…åç«¯... ($i/30)"
            sleep 2
          done
          
          # å‰ç«¯å¥åº·æ£€æŸ¥
          echo "æ£€æŸ¥å‰ç«¯..."
          for i in {1..30}; do
            if curl -f http://localhost:3000; then
              echo "âœ“ å‰ç«¯å¯åŠ¨æˆåŠŸ"
              break
            fi
            echo "ç­‰å¾…å‰ç«¯... ($i/30)"
            sleep 2
          done
      
      - name: ğŸ§ª è¿è¡ŒDockerç¯å¢ƒæµ‹è¯•
        run: |
          chmod +x scripts/test_docker_environment.sh
          AUTO_CLEANUP=false ./scripts/test_docker_environment.sh
      
      - name: ğŸ“‹ æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ï¼‰
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker-compose logs backend
          echo "=== Frontend Logs ==="
          docker-compose logs frontend
      
      - name: ğŸ§¹ æ¸…ç†ç¯å¢ƒ
        if: always()
        run: |
          docker-compose down -v
          docker system prune -f

  # ================================
  # E2Eæµ‹è¯•
  # ================================
  e2e-test:
    name: ç«¯åˆ°ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    needs: docker-test
    
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ­ å®‰è£…Playwright
        run: |
          npm install -D @playwright/test
          npx playwright install --with-deps chromium
      
      - name: ğŸ”§ è®¾ç½®ç¯å¢ƒï¼ˆä½¿ç”¨çœŸå®API keyï¼‰
        run: |
          cp .env.example .env
          # å¦‚æœæœ‰GOOGLE_API_KEY secretï¼Œä½¿ç”¨çœŸå®keyï¼Œå¦åˆ™ç”¨mockï¼ˆä¼šå¯¼è‡´çœŸå®E2Eæµ‹è¯•è·³è¿‡ï¼‰
          echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY || 'mock-api-key' }}" >> .env
        env:
          # æç¤ºï¼šéœ€è¦åœ¨GitHubä»“åº“Settings -> Secretsæ·»åŠ GOOGLE_API_KEY
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      
      - name: ğŸ³ å¯åŠ¨Dockerç¯å¢ƒ
        run: |
          docker-compose up -d
          sleep 25
      
      - name: ğŸ¥ å¥åº·æ£€æŸ¥
        run: |
          # ç­‰å¾…æœåŠ¡å®Œå…¨å°±ç»ª
          for i in {1..30}; do
            if curl -f http://localhost:5000/health && curl -f http://localhost:3000; then
              echo "âœ“ æœåŠ¡å°±ç»ª"
              break
            fi
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/30)"
            sleep 2
          done
      
      - name: ğŸ¬ è¿è¡ŒåŸºç¡€E2Eæµ‹è¯•
        run: |
          # è¿è¡ŒåŸºç¡€UIæµ‹è¯•ï¼ˆä¸ä¾èµ–çœŸå®APIï¼‰
          npx playwright test home.spec.ts create-ppt.spec.ts
        env:
          CI: true
        continue-on-error: false
      
      - name: ğŸš€ è¿è¡Œå®Œæ•´æµç¨‹E2Eæµ‹è¯•ï¼ˆéœ€è¦çœŸå®APIï¼‰
        if: secrets.GOOGLE_API_KEY != ''
        run: |
          # è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•ï¼ˆä»åˆ›å»ºåˆ°å¯¼å‡ºPPTï¼‰
          npx playwright test full-flow.spec.ts --workers=1
        env:
          CI: true
        timeout-minutes: 15
        continue-on-error: false
      
      - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
      
      - name: ğŸ“¸ ä¸Šä¼ å¤±è´¥æˆªå›¾
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7
      
      - name: ğŸ§¹ æ¸…ç†
        if: always()
        run: docker-compose down -v

  # ================================
  # å®‰å…¨æ‰«æ
  # ================================
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ” åç«¯ä¾èµ–å®‰å…¨æ‰«æ
        run: |
          pip install safety
          safety check --json || echo "å‘ç°å®‰å…¨æ¼æ´ï¼ˆè­¦å‘Šï¼‰"
        continue-on-error: true
      
      - name: ğŸ” å‰ç«¯ä¾èµ–å®‰å…¨æ‰«æ
        run: |
          cd frontend
          npm audit --audit-level=moderate || echo "å‘ç°å®‰å…¨æ¼æ´ï¼ˆè­¦å‘Šï¼‰"
        continue-on-error: true
      
      - name: ğŸ”’ Dockerfileå®‰å…¨æ‰«æ
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: backend/Dockerfile
        continue-on-error: true

  # ================================
  # æµ‹è¯•æ€»ç»“
  # ================================
  test-summary:
    name: ğŸ“Š æµ‹è¯•æ€»ç»“
    runs-on: ubuntu-latest
    needs: [backend-unit-test, backend-integration-test, frontend-test, docker-test, e2e-test, security-scan]
    if: always()
    
    steps:
      - name: ğŸ“Š è¾“å‡ºæµ‹è¯•ç»“æœ
        run: |
          echo "================================="
          echo "ğŸ¯ CI/CD æµ‹è¯•å®Œæˆ"
          echo "================================="
          echo ""
          echo "æµ‹è¯•ç»“æœï¼š"
          echo "  åç«¯å•å…ƒæµ‹è¯•: ${{ needs.backend-unit-test.result }}"
          echo "  åç«¯é›†æˆæµ‹è¯•: ${{ needs.backend-integration-test.result }}"
          echo "  å‰ç«¯æµ‹è¯•: ${{ needs.frontend-test.result }}"
          echo "  Dockerç¯å¢ƒæµ‹è¯•: ${{ needs.docker-test.result }}"
          echo "  E2Eæµ‹è¯•: ${{ needs.e2e-test.result }}"
          echo "  å®‰å…¨æ‰«æ: ${{ needs.security-scan.result }}"
          echo ""
      
      - name: âœ… æ£€æŸ¥æ˜¯å¦å…¨éƒ¨é€šè¿‡
        if: |
          needs.backend-unit-test.result != 'success' ||
          needs.backend-integration-test.result != 'success' ||
          needs.frontend-test.result != 'success' ||
          needs.docker-test.result != 'success' ||
          needs.e2e-test.result != 'success'
        run: |
          echo "âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1
      
      - name: ğŸ‰ å…¨éƒ¨æµ‹è¯•é€šè¿‡
        if: |
          needs.backend-unit-test.result == 'success' &&
          needs.backend-integration-test.result == 'success' &&
          needs.frontend-test.result == 'success' &&
          needs.docker-test.result == 'success' &&
          needs.e2e-test.result == 'success'
        run: |
          echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å¯ä»¥åˆå¹¶ä»£ç "

